name: SSH over SSL Port 80

on: [push, workflow_dispatch]

jobs:
  sshssl:
    runs-on: ubuntu-latest

    steps:
    - name: Set password for runner
      run: echo -e "runner:Passw0rd123" | sudo chpasswd

    - name: Install and start SSH
      run: |
        sudo apt update
        sudo apt install -y openssh-server
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl enable ssh
        sudo service ssh restart

    - name: Download ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xvzf ngrok-v3-stable-linux-amd64.tgz
        sudo mv ngrok /usr/local/bin/ngrok
        chmod +x /usr/local/bin/ngrok

    - name: Authenticate ngrok
      run: ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Start ngrok TCP tunnel to SSH on port 80
      run: ngrok tcp --region=eu --remote-addr 0.tcp.eu.ngrok.io:80 22 > ngrok.log &
    
    - name: Wait for ngrok to initialize
      run: sleep 10

    - name: Output tunnel info
      run: |
        echo "==================================="
        echo "SSH ready on port 80 over ngrok"
        echo "Username: runner"
        echo "Password: Passw0rd123"
        echo "Server: 0.tcp.eu.ngrok.io"
        echo "Port: 80"
        echo "==================================="
